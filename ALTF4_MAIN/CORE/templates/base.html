<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>STEM Hub | Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
 
  <style>
    /* --- Reset & Base Styles --- */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
   
    body {
      background: #f4f6f9;
      color: #333;
      overflow-x: hidden;
    }

    a { text-decoration: none; color: inherit; }
    ul { list-style: none; }

    /* --- Glassmorphism Header --- */
    header {
      background: rgba(255, 255, 255, 0.95);
      color: #1e293b;
      padding: 1rem 5%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      position: sticky;
      top: 0;
      z-index: 1000;
      backdrop-filter: blur(10px);
    }
   
    header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #2563eb; /* Primary Brand Color */
      letter-spacing: -0.5px;
    }

    nav { display: flex; gap: 2rem; align-items: center; }
    nav a {
      font-weight: 500;
      font-size: 0.95rem;
      color: #64748b;
      transition: color 0.3s;
    }
    nav a:hover { color: #2563eb; }
   
    /* Logout button style */
    .logout-btn {
      padding: 0.5rem 1.2rem;
      border: 1px solid #e2e8f0;
      border-radius: 2rem;
      font-size: 0.9rem;
      transition: all 0.3s;
    }
    .logout-btn:hover {
      background: #eff6ff;
      border-color: #2563eb;
      color: #2563eb;
    }

    /* --- Notification Bell & Dropdown CSS --- */
    .notif-container {
      position: relative;
      margin-left: 0.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
    }

    .bell-icon {
      font-size: 1.5rem;
      color: #64748b;
      transition: color 0.3s;
    }
    .bell-icon:hover { color: #2563eb; }

    .badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #ef4444;
      color: white;
      font-size: 0.7rem;
      font-weight: bold;
      padding: 2px 6px;
      border-radius: 50%;
      border: 2px solid white;
    }

    .notif-dropdown {
      display: none; /* Hidden by default */
      position: absolute;
      top: 150%;
      right: -10px;
      width: 340px;
      background: white;
      border-radius: 0.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      border: 1px solid #e2e8f0;
      z-index: 1100;
      overflow: hidden;
    }
    .notif-dropdown.active { display: block; }

    .notif-header {
      padding: 0.8rem 1rem;
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
      font-weight: 600;
      font-size: 0.9rem;
      color: #334155;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .notif-list {
      max-height: 350px;
      overflow-y: auto;
    }

    /* --- Dynamic Notification Colors --- */
    .notif-item {
      padding: 0.8rem 1rem;
      border-bottom: 1px solid #e2e8f0;
      font-size: 0.85rem;
      color: #475569;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
      /* Default border incase type is missing */
      border-left: 4px solid #cbd5e1; 
      background: white;
    }

    /* Warning (Red) */
    .notif-item.warning {
        border-left-color: #ef4444; 
        background: #fef2f2;
    }
    
    /* Info (Blue) */
    .notif-item.info {
        border-left-color: #3b82f6;
        background: #eff6ff;
    }

    /* Success (Green) */
    .notif-item.success {
        border-left-color: #22c55e;
        background: #f0fdf4;
    }

    .notif-item:hover {
       filter: brightness(0.98); /* Slight darken on hover */
    }

    .notif-item:last-child { border-bottom: none; }
    
    .notif-item .mark-read {
        color: #94a3b8;
        font-size: 1rem;
        cursor: pointer;
        text-decoration: none;
        padding-left: 5px;
        transition: color 0.2s;
    }
    .notif-item .mark-read:hover { color: #2563eb; }


    /* --- Hero Section --- */
    .hero {
      background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
      color: white;
      text-align: center;
      padding: 5rem 2rem;
      margin: 2rem auto;
      width: 90%;
      border-radius: 1.5rem;
      box-shadow: 0 10px 25px -5px rgba(37, 99, 235, 0.4);
      position: relative;
      overflow: hidden;
    }
   
    .hero::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -20%;
      width: 500px;
      height: 500px;
      background: rgba(255,255,255,0.1);
      border-radius: 50%;
    }

    .hero h1 { font-size: 2.5rem; margin-bottom: 1rem; font-weight: 700; }
    .hero p { font-size: 1.1rem; margin-bottom: 2rem; opacity: 0.9; font-weight: 300; }
   
    .hero-buttons { display: flex; gap: 1rem; justify-content: center; }

    .hero button, .hero a.reserve-now {
      padding: 0.9rem 2rem;
      border: none;
      border-radius: 3rem;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      transition: transform 0.2s, box-shadow 0.2s;
      display: inline-block;
    }
   
    .hero .view-labs {
      background: white;
      color: #2563eb;
    }
    .hero .view-labs:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255,255,255,0.3);
    }
   
    .hero .reserve-now {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
      backdrop-filter: blur(5px);
    }
    .hero .reserve-now:hover {
      background: rgba(255,255,255,0.3);
    }

    /* --- Section Headings --- */
    .section-title {
      padding: 0 5%;
      margin-bottom: 1.5rem;
      font-size: 1.5rem;
      color: #1e293b;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .section-title::before {
      content: '';
      display: block;
      width: 5px;
      height: 25px;
      background: #2563eb;
      border-radius: 3px;
    }

    /* --- Lab Cards --- */
    .labs {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
      padding: 0 5%;
      margin-bottom: 4rem;
    }
   
    .lab-card {
      background: white;
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      transition: all 0.3s ease;
      border: 1px solid #f1f5f9;
      display: flex;
      flex-direction: column; 
    }
   
    .lab-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
   
    .lab-card img { width: 100%; height: 200px; object-fit: cover; }
   
    .lab-card .content { 
      padding: 1.5rem; 
      display: flex; 
      flex-direction: column; 
      flex-grow: 1; 
    }
    .lab-card h3 { font-size: 1.25rem; margin-bottom: 0.5rem; color: #1e293b; }
    .lab-card p { font-size: 0.9rem; color: #64748b; margin-bottom: 0.5rem; line-height: 1.5; }
   
    .lab-meta {
      display: flex;
      justify-content: space-between;
      margin-top: auto; 
      padding-top: 1rem;
      border-top: 1px solid #f1f5f9;
      font-size: 0.85rem;
      color: #94a3b8;
      font-weight: 500;
    }

    /* --- Buttons Container & Styling --- */
    .lab-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1.2rem;
    }

    .lab-actions button, .lab-actions a {
      flex: 1;
      padding: 0.8rem;
      border-radius: 0.5rem;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      text-align: center;
      transition: all 0.2s;
    }

    /* Primary Button (Book Slot) */
    .btn-book {
      background: #2563eb;
      color: white;
      border: none;
    }
    .btn-book:hover { background: #1d4ed8; }

    /* Secondary Button (View in Map) */
    .btn-map {
      background: white;
      color: #2563eb;
      border: 1px solid #2563eb;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn-map:hover { background: #eff6ff; }


    /* --- Notifications (Old Section - Can be removed if needed) --- */
    .notifications-wrapper {
      padding: 0 5%;
      margin-bottom: 4rem;
    }
    .notifications {
      background: #fffbeb;
      border-left: 5px solid #f59e0b;
      padding: 1.5rem 2rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
    }
    .notifications h2 { margin-bottom: 1rem; font-size: 1.2rem; color: #92400e; }
    .notifications ul { list-style: none; padding: 0; }
    .notifications li {
      margin-bottom: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.95rem;
      color: #78350f;
    }
    .notifications li::before {
      content: 'â€¢';
      color: #f59e0b;
      font-size: 1.5rem;
      line-height: 0.8rem;
    }

    /* --- Footer --- */
    footer {
      background: #0f172a;
      color: #94a3b8;
      text-align: center;
      padding: 2rem;
      font-size: 0.9rem;
    }

    /* --- Modal --- */
    .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); justify-content:center; align-items:center; z-index: 2000; }
    .modal-content {
      background: white;
      padding: 2.5rem;
      border-radius: 1rem;
      width: 90%;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      animation: fadeIn 0.3s ease;
    }
   
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .modal-content h3 { margin-bottom: 1.5rem; color: #1e293b; }
    .modal-content button {
      margin-top: 1rem;
      background: #2563eb;
      color: white;
      padding: 0.8rem 2rem;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      font-weight: 600;
    }
    .modal-content button.close-btn {
      background: #e2e8f0;
      color: #64748b;
      margin-left: 0.5rem;
    }
  </style>
</head>
<body>

  <header>
    <h1><a href="/">STEM Hub</a></h1>
    <nav>
      <a href="{% url 'labs:index' %}">Map</a>
      <a href="{% url 'reservations:timetable' %}">Calendar</a>        
      {% if not user.is_staff and not user.is_superuser %}
          <a href="{% url 'reservations:my_reservations' %}">My Reservations</a>
      {% endif %}    
      {% if user.is_staff %}
        <a href="{% url 'reservations:dashboard' %}" style="color: #ef4444; font-weight: bold; border: 1px solid #fca5a5; padding: 0.25rem 0.75rem; border-radius: 9999px;">Admin Panel</a>
        <a href="/analytics/dashboard/" style="color: #ef4444; font-weight: bold; border: 1px solid #fca5a5; padding: 0.25rem 0.75rem; border-radius: 9999px;">Analytics</a>
        <a href="{% url 'notifications:create_announcement' %}" style="color: #2563eb; font-weight: bold; border: 1px solid #bfdbfe; padding: 0.25rem 0.75rem; border-radius: 9999px;">Broadcast</a>
      {% endif %}

      {% if user.is_authenticated %}
      <div class="notif-container" onclick="toggleNotif()">
        <span class="bell-icon">ðŸ””</span> 
        
        {% if unread_count > 0 %}
            <span class="badge">{{ unread_count }}</span>
        {% endif %}

        <div class="notif-dropdown" id="notifDropdown">
            <div class="notif-header">
                Notifications
                <span style="font-size:0.8rem; color:#64748b;">{{ unread_count|default:"0" }} New</span>
            </div>
            <div class="notif-list">
                {% if notifications_list %}
                    {% for notif in notifications_list %}
                        <div class="notif-item {{ notif.notification_type }}">
                            <span>{{ notif.message }}</span>
                            <a href="{% url 'notifications:mark_read' notif.id %}" class="mark-read" title="Mark as read">âœ”</a>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="notif-item" style="justify-content: center; color: #94a3b8; border-left: 4px solid #e2e8f0;">
                        No new notifications
                    </div>
                {% endif %}
            </div>
        </div>
      </div>
      {% endif %}
      <a href="{% url 'logout' %}" class="logout-btn">Log Out</a>
    </nav>
  </header>

  <section class="hero">
    <h1>Welcome back, {{ user.first_name|default:"Student" }}</h1>
    <p>Your academic dashboard for labs, equipment, and resources.</p>
    <div class="hero-buttons">
      <button class="view-labs" onclick="scrollToLabs()">Browse Labs</button>
      <a href="{% url 'labs:index' %}" class="reserve-now">View Interactive Map</a>
    </div>
  </section>

  <div class="section-title">Available Facilities</div>
  
  <section class="labs" id="labs">
    {% if labs %}
        {% for lab in labs %}
            {% if lab.is_active %}
                <div class="lab-card">
                    {% if lab.image %}
                        <img src="{{ lab.image.url }}" alt="{{ lab.name }}">
                    {% else %}
                        <img src="https://placehold.co/600x400/2563eb/FFF?text={{ lab.name|urlencode }}" alt="{{ lab.name }}">
                    {% endif %}

                    <div class="content">
                        <h3>{{ lab.name }}</h3>
                        <p>{{ lab.description|truncatewords:20 }}</p>
                        
                        <div class="lab-meta">
                            <span>Cap: {{ lab.capacity }} students</span>
                            <span>{{ lab.equipment.count|default:"0" }} items</span>
                        </div>
                        
                        <div class="lab-actions">
                            <button class="btn-book" onclick="openModal('Reserve {{ lab.name|escapejs }}?')">Book Slot</button>
                            <a href="{% url 'labs:index' %}" class="btn-map">View in Map</a>
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    {% else %}
        <div style="grid-column: 1/-1; text-align: center; color: #64748b; padding: 2rem;">
            <p>No available labs found.</p>
        </div>
    {% endif %}
  </section>

  <div class="section-title">Updates & Alerts</div>
  <section class="notifications-wrapper">
    <div class="notifications">
      <h2>Recent Notifications</h2>
      <ul id="notifications-list">
        </ul>
    </div>
  </section>

  <footer>
    <p>Â© 2025 STEM Hub | University Labs Management System</p>
  </footer>

  <div class="modal" id="modal">
    <div class="modal-content" id="modal-content">
      <h3>Modal Title</h3>
      <p style="color: #64748b; margin-bottom: 1.5rem;">Confirm your action below.</p>
      <button onclick="alert('Confirmed!')">Confirm</button>
      <button class="close-btn" onclick="closeModal()">Close</button>
    </div>
  </div>

  <script>
    // --- Mock Notifications (Existing) ---
    const notifications = [
      "Physics Lab maintenance scheduled for 12 Dec, 2 PM",
      "Robotics Lab is fully booked for the current week",
      "New shipment of Chemicals arrived in Lab 2"
    ];

    const notifContainer = document.getElementById('notifications-list');
    if(notifContainer){
        notifications.forEach(note => {
          notifContainer.innerHTML += `<li>${note}</li>`;
        });
    }

    // --- Modal Functions ---
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modal-content');

    function openModal(msg){
      modal.style.display = 'flex';
      modalContent.querySelector('h3').innerText = msg;
    }

    function closeModal(){
      modal.style.display = 'none';
    }
   
    function scrollToLabs(){
      document.getElementById('labs').scrollIntoView({behavior:'smooth'});
    }

    // --- NOTIFICATION BELL LOGIC ---
    function toggleNotif() {
      const dropdown = document.getElementById('notifDropdown');
      if (dropdown.style.display === 'block') {
        dropdown.style.display = 'none';
      } else {
        dropdown.style.display = 'block';
      }
    }

    window.onclick = function(event) {
      if (event.target == modal) {
        closeModal();
      }
      const notifContainer = document.querySelector('.notif-container');
      const dropdown = document.getElementById('notifDropdown');
      
      // Close dropdown if clicking outside
      if (notifContainer && !notifContainer.contains(event.target)) {
         if(dropdown) dropdown.style.display = 'none';
      }
    }
  </script>

</body>
</html>